"""
Korpus-Manager fÃ¼r die Bundeskanzler-KI.
Verwaltet das Laden, Speichern und Validieren des Trainingskorpus.
"""
import json
import os
import logging
from typing import List, Dict, Optional, Tuple
from collections import defaultdict
from corpus_validator import CorpusValidator, print_validation_report

class CorpusManager:
    def __init__(self, corpus_file: str = "corpus.json"):
        """
        Initialisiert den Korpus-Manager.
        
        Args:
            corpus_file: Pfad zur Korpus-Datei (JSON-Format)
        """
        self.corpus_file = corpus_file
        self.corpus: Dict[str, List[Dict[str, str]]] = defaultdict(list)
        self.validator = CorpusValidator()
        self.load_corpus()
    
    def load_corpus(self) -> None:
        """LÃ¤dt den Korpus aus der JSON-Datei."""
        if os.path.exists(self.corpus_file):
            try:
                with open(self.corpus_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    # Verarbeite das neue Format
                    self.corpus = defaultdict(list)
                    if 'entries' in data:
                        print(f"Gefundene EintrÃ¤ge im Korpus: {len(data['entries'])}")
                        for entry in data['entries']:
                            if isinstance(entry, dict) and 'text' in entry:
                                cat = entry.get('topic', 'default')
                                self.corpus[cat].append({
                                    'text': entry['text'],
                                    'language': entry.get('language', 'de')
                                })
                                print(f"HinzugefÃ¼gter Text: {entry['text'][:50]}...")
                            else:
                                logging.warning(f"UngÃ¼ltiger Eintrag im Korpus: {entry}")
                    print(f"Geladener Korpus enthÃ¤lt {sum(len(v) for v in self.corpus.values())} EintrÃ¤ge")
                    logging.info(f"Korpus geladen aus {self.corpus_file} mit {sum(len(v) for v in self.corpus.values())} EintrÃ¤gen")
                    # Entferne Duplikate nach dem Laden
                    self._deduplicate_corpus()
            except Exception as e:
                logging.error(f"Fehler beim Laden des Korpus: {e}")
                self._initialize_default_corpus()
        else:
            logging.warning(f"{self.corpus_file} nicht gefunden, initialisiere Standard-Korpus")
            self._initialize_default_corpus()
    
    def _deduplicate_corpus(self) -> None:
        """Entfernt Duplikate aus dem Korpus basierend auf dem Text-Inhalt."""
        seen_texts = set()
        deduplicated_corpus = defaultdict(list)
        
        for category, items in self.corpus.items():
            for item in items:
                text = item['text']
                if text not in seen_texts:
                    seen_texts.add(text)
                    deduplicated_corpus[category].append(item)
        
        original_count = sum(len(v) for v in self.corpus.values())
        deduplicated_count = sum(len(v) for v in deduplicated_corpus.values())
        removed_duplicates = original_count - deduplicated_count
        
        self.corpus = deduplicated_corpus
        
        if removed_duplicates > 0:
            print(f"Duplikate entfernt: {removed_duplicates} EintrÃ¤ge (von {original_count} auf {deduplicated_count})")
            logging.info(f"Duplikate entfernt: {removed_duplicates} EintrÃ¤ge")
        else:
            print("Keine Duplikate gefunden")
    
    def save_corpus(self) -> None:
        """Speichert den Korpus in die JSON-Datei (als Eintragsliste)."""
        try:
            entries = []
            for cat, items in self.corpus.items():
                for item in items:
                    entry = {
                        'text': item['text'],
                        'topic': cat,
                        'language': item.get('language', 'de'),
                        'date': '2025-09-13',
                        'source': 'regierung',
                        'verified': True
                    }
                    entries.append(entry)
            with open(self.corpus_file, 'w', encoding='utf-8') as f:
                json.dump({'entries': entries}, f, ensure_ascii=False, indent=2)
            logging.info(f"Korpus gespeichert in {self.corpus_file}")
        except Exception as e:
            logging.error(f"Fehler beim Speichern des Korpus: {e}")
    
    def add_sentence(self, sentence: str, category: str, language: str) -> None:
        """
        FÃ¼gt einen neuen Satz zum Korpus hinzu.
        """
        if not category in self.corpus:
            self.corpus[category] = []
        self.corpus[category].append({
            'text': sentence,
            'language': language
        })
    
    def get_all_sentences(self) -> List[str]:
        """Gibt alle SÃ¤tze aus dem Korpus als Liste von Strings zurÃ¼ck."""
        result = []
        for items in self.corpus.values():
            for item in items:
                result.append(item['text'])
        return result
    
    def get_sentences_by_category(self, category: str) -> List[str]:
        """Gibt alle SÃ¤tze einer bestimmten Kategorie zurÃ¼ck."""
        return [item['text'] for item in self.corpus.get(category, [])]
    
    def get_sentences_by_language(self, language: str) -> List[str]:
        """Gibt alle SÃ¤tze einer bestimmten Sprache zurÃ¼ck."""
        result = []
        for items in self.corpus.values():
            for item in items:
                if item.get('language', 'de') == language:
                    result.append(item['text'])
        return result

    def get_categories(self) -> List[str]:
        """Gibt alle verfÃ¼gbaren Kategorien zurÃ¼ck."""
        return list(self.corpus.keys())
    
    def get_statistics(self) -> Dict[str, Dict[str, int]]:
        """Gibt Statistiken Ã¼ber den Korpus zurÃ¼ck."""
        stats = {
            'total': sum(len(items) for items in self.corpus.values()),
            'by_category': {cat: len(items) for cat, items in self.corpus.items()},
            'by_language': {}
        }
        lang_count = {}
        for items in self.corpus.values():
            for item in items:
                lang = item.get('language', 'de')
                lang_count[lang] = lang_count.get(lang, 0) + 1
        stats['by_language'] = lang_count
        return stats
    
    def validate_corpus(self, print_report: bool = True) -> Dict:
        """
        FÃ¼hrt eine vollstÃ¤ndige Validierung des Korpus durch.
        
        Args:
            print_report: Wenn True, wird ein formatierter Bericht ausgegeben
        
        Returns:
            Dict mit Validierungsergebnissen
        """
        sentences = self.get_all_sentences()
        results = self.validator.validate_corpus(sentences)
        
        if print_report:
            print_validation_report(results)
        
        return results
    
    def _initialize_default_corpus(self) -> None:
        """Initialisiert einen Standard-Korpus mit Beispieldaten als Dictionary."""
        self.corpus = defaultdict(list)
        beispielsaetze = [
            "Wir arbeiten hart daran, Deutschland voranzubringen.",
            "Die Bundesregierung setzt sich fÃ¼r soziale Gerechtigkeit ein.",
            "Klimaschutz ist eine unserer wichtigsten Aufgaben."
        ]
        for text in beispielsaetze:
            self.corpus['allgemein'].append({'text': text, 'language': 'de'})
        # Speichere im neuen Format
        with open(self.corpus_file, 'w', encoding='utf-8') as f:
            json.dump({
                "entries": [
                    {
                        "text": text,
                        "topic": "allgemein",
                        "language": "de",
                        "date": "2025-09-13",
                        "source": "regierung",
                        "verified": True
                    } for text in beispielsaetze
                ]
            }, f, ensure_ascii=False, indent=2)
    
    def expand_corpus_with_government_data(self) -> None:
        """Erweitert den Korpus mit zusÃ¤tzlichen Regierungsdaten aus verschiedenen Bereichen."""
        print("ğŸ“š Erweitere Korpus mit zusÃ¤tzlichen Regierungsdaten...")
        
        # Erweiterte Daten fÃ¼r verschiedene politische Bereiche
        additional_data = [
            # Wirtschaft und Arbeit
            {
                "text": "Die Bundesregierung setzt sich fÃ¼r VollbeschÃ¤ftigung und faire LÃ¶hne ein. Mindestlohn wird regelmÃ¤ÃŸig angepasst.",
                "topic": "wirtschaft",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_arbeit",
                "verified": True
            },
            {
                "text": "Start-ups und Mittelstand werden durch verbesserte FinanzierungsmÃ¶glichkeiten und BÃ¼rokratieabbau unterstÃ¼tzt.",
                "topic": "wirtschaft",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_wirtschaft",
                "verified": True
            },
            {
                "text": "Die Bundesregierung fÃ¶rdert die duale Berufsausbildung und stÃ¤rkt die berufliche Weiterbildung.",
                "topic": "bildung",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_bildung",
                "verified": True
            },
            
            # Soziales und Gesundheit
            {
                "text": "Die Kindergrundsicherung wird eingefÃ¼hrt, um Kinderarmut zu bekÃ¤mpfen und Familien zu entlasten.",
                "topic": "soziales",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_familie",
                "verified": True
            },
            {
                "text": "Das Gesundheitssystem wird durch Digitalisierung und PrÃ¤vention gestÃ¤rkt. Telematikinfrastruktur wird ausgebaut.",
                "topic": "gesundheit",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_gesundheit",
                "verified": True
            },
            {
                "text": "Die Pflegeversicherung wird reformiert, um bessere Arbeitsbedingungen fÃ¼r PflegekrÃ¤fte zu schaffen.",
                "topic": "gesundheit",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_gesundheit",
                "verified": True
            },
            
            # AuÃŸenpolitik und Europa
            {
                "text": "Deutschland setzt sich fÃ¼r eine starke EuropÃ¤ische Union und transatlantische Partnerschaft ein.",
                "topic": "international",
                "language": "de",
                "date": "2025-09-15",
                "source": "auswaertiges_amt",
                "verified": True
            },
            {
                "text": "Internationale Zusammenarbeit beim Klimaschutz ist ein zentraler Pfeiler deutscher AuÃŸenpolitik.",
                "topic": "international",
                "language": "de",
                "date": "2025-09-15",
                "source": "auswaertiges_amt",
                "verified": True
            },
            
            # Technologie und Zukunft
            {
                "text": "Deutschland wird bis 2030 fÃ¼hrend in der KI-Entwicklung und setzt auf vertrauenswÃ¼rdige KI.",
                "topic": "technologie",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_wirtschaft",
                "verified": True
            },
            {
                "text": "Deutschland fÃ¼hrt bei der Entwicklung von Wasserstofftechnologie und grÃ¼ner Stahlproduktion.",
                "topic": "technologie",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_wirtschaft",
                "verified": True
            },
            {
                "text": "Die Bildungsreform stÃ¤rkt digitale Kompetenzen in Schulen und Hochschulen.",
                "topic": "bildung",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_bildung",
                "verified": True
            },
            
            # Sicherheit und Inneres
            {
                "text": "Die Bundesregierung investiert in die digitale SouverÃ¤nitÃ¤t und Cybersicherheit Deutschlands.",
                "topic": "sicherheit",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_des_innern",
                "verified": True
            },
            {
                "text": "Der BevÃ¶lkerungsschutz wird durch moderne FrÃ¼hwarnsysteme und Katastrophenschutz gestÃ¤rkt.",
                "topic": "sicherheit",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_des_innern",
                "verified": True
            },
            
            # Verkehr und Infrastruktur
            {
                "text": "Deutschland baut das Schienennetz aus und setzt auf klimafreundliche MobilitÃ¤t.",
                "topic": "verkehr",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_verkehr",
                "verified": True
            },
            {
                "text": "Die Ladeinfrastruktur fÃ¼r Elektrofahrzeuge wird massiv ausgebaut.",
                "topic": "verkehr",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_verkehr",
                "verified": True
            },
            
            # Landwirtschaft und ErnÃ¤hrung
            {
                "text": "Die Landwirtschaft wird durch nachhaltige Praktiken und BiodiversitÃ¤tsschutz unterstÃ¼tzt.",
                "topic": "landwirtschaft",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_ernaehrung",
                "verified": True
            },
            
            # Kultur und Medien
            {
                "text": "Kulturelle Bildung wird gefÃ¶rdert und der Zugang zu Kunst und Kultur fÃ¼r alle ermÃ¶glicht.",
                "topic": "kultur",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_kultur",
                "verified": True
            },
            
            # Justiz und Recht
            {
                "text": "Die Justiz wird digitalisiert und der Zugang zum Recht fÃ¼r alle BÃ¼rgerinnen und BÃ¼rger verbessert.",
                "topic": "justiz",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_der_justiz",
                "verified": True
            },
            
            # Englische EintrÃ¤ge fÃ¼r internationale Kontexte
            {
                "text": "Germany is committed to ambitious climate protection goals. Climate neutrality should be achieved by 2045.",
                "topic": "klima",
                "language": "en",
                "date": "2025-09-15",
                "source": "government",
                "verified": True
            },
            {
                "text": "The federal government promotes the expansion of renewable energies through the EEG and various funding programs.",
                "topic": "energie",
                "language": "en",
                "date": "2025-09-15",
                "source": "government",
                "verified": True
            },
            {
                "text": "Germany invests in future technologies such as AI, quantum computing and hydrogen technology.",
                "topic": "innovation",
                "language": "en",
                "date": "2025-09-15",
                "source": "government",
                "verified": True
            }
        ]
        
        # FÃ¼ge neue Daten zum Korpus hinzu
        for entry in additional_data:
            category = entry['topic']
            if category not in self.corpus:
                self.corpus[category] = []
            
            # PrÃ¼fe auf Duplikate
            existing_texts = [item['text'] for item in self.corpus[category]]
            if entry['text'] not in existing_texts:
                self.corpus[category].append({
                    'text': entry['text'],
                    'language': entry['language']
                })
        
        print(f"âœ… Korpus um {len(additional_data)} EintrÃ¤ge erweitert")
        self.save_corpus()
    
    def expand_corpus_with_eu_data(self) -> None:
        """Erweitert den Korpus mit EU-bezogenen Daten und europÃ¤ischen Kontexten."""
        print("ğŸ‡ªğŸ‡º Erweitere Korpus mit EU-Daten...")
        
        eu_data = [
            # EuropÃ¤ische Union und Institutionen
            {
                "text": "Die EuropÃ¤ische Union ist eine Wertegemeinschaft, die auf Demokratie, Rechtsstaatlichkeit und Menschenrechten basiert.",
                "topic": "europa",
                "language": "de",
                "date": "2025-09-15",
                "source": "europaeische_kommission",
                "verified": True
            },
            {
                "text": "Deutschland setzt sich fÃ¼r eine starke Rolle der EU in der Welt ein und unterstÃ¼tzt die Gemeinsame AuÃŸen- und Sicherheitspolitik.",
                "topic": "europa",
                "language": "de",
                "date": "2025-09-15",
                "source": "auswaertiges_amt",
                "verified": True
            },
            {
                "text": "Der Green Deal der EuropÃ¤ischen Union zielt auf KlimaneutralitÃ¤t bis 2050 und nachhaltige Entwicklung ab.",
                "topic": "europa",
                "language": "de",
                "date": "2025-09-15",
                "source": "europaeische_kommission",
                "verified": True
            },
            {
                "text": "Die EU fÃ¶rdert die digitale Transformation durch Programme wie Digital Europe und InvestEU.",
                "topic": "europa",
                "language": "de",
                "date": "2025-09-15",
                "source": "europaeische_kommission",
                "verified": True
            },
            {
                "text": "Deutschland trÃ¤gt als Nettozahler wesentlich zum EU-Haushalt bei und profitiert vom Binnenmarkt.",
                "topic": "europa",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesfinanzministerium",
                "verified": True
            },
            
            # Englische EU-EintrÃ¤ge
            {
                "text": "The European Union is a community of values based on democracy, rule of law and human rights.",
                "topic": "europa",
                "language": "en",
                "date": "2025-09-15",
                "source": "european_commission",
                "verified": True
            },
            {
                "text": "Germany advocates for a strong EU role in the world and supports the Common Foreign and Security Policy.",
                "topic": "europa",
                "language": "en",
                "date": "2025-09-15",
                "source": "foreign_office",
                "verified": True
            },
            {
                "text": "The European Green Deal aims for climate neutrality by 2050 and sustainable development.",
                "topic": "europa",
                "language": "en",
                "date": "2025-09-15",
                "source": "european_commission",
                "verified": True
            }
        ]
        
        # FÃ¼ge EU-Daten hinzu
        for entry in eu_data:
            category = entry['topic']
            if category not in self.corpus:
                self.corpus[category] = []
            
            # PrÃ¼fe auf Duplikate
            existing_texts = [item['text'] for item in self.corpus[category]]
            if entry['text'] not in existing_texts:
                self.corpus[category].append({
                    'text': entry['text'],
                    'language': entry['language']
                })
        
        print(f"âœ… Korpus um {len(eu_data)} EU-EintrÃ¤ge erweitert")
        self.save_corpus()
    
    def expand_corpus_with_policy_data(self) -> None:
        """Erweitert den Korpus mit spezifischen Policy-Daten und politischen Positionen."""
        print("ğŸ“‹ Erweitere Korpus mit Policy-Daten...")
        
        policy_data = [
            # Wirtschaftspolitik
            {
                "text": "Die Bundesregierung verfolgt eine Politik der sozialen Marktwirtschaft mit AugenmaÃŸ und setzt auf Innovation und Nachhaltigkeit.",
                "topic": "politik",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundeskanzleramt",
                "verified": True
            },
            {
                "text": "Deutschland setzt auf Industrie 4.0 und stÃ¤rkt die WettbewerbsfÃ¤higkeit durch Forschung und Entwicklung.",
                "topic": "politik",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_wirtschaft",
                "verified": True
            },
            
            # Sozialpolitik
            {
                "text": "Die Bundesregierung bekÃ¤mpft Altersarmut durch eine stabile Rente und private Altersvorsorge.",
                "topic": "soziales",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_fuer_arbeit",
                "verified": True
            },
            {
                "text": "Integration und Teilhabe sind zentrale SÃ¤ulen der deutschen Sozialpolitik.",
                "topic": "soziales",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_des_innern",
                "verified": True
            },
            
            # AuÃŸenpolitik
            {
                "text": "Deutschland setzt sich fÃ¼r eine wertebasierte AuÃŸenpolitik und die StÃ¤rkung multilateraler Institutionen ein.",
                "topic": "international",
                "language": "de",
                "date": "2025-09-15",
                "source": "auswaertiges_amt",
                "verified": True
            },
            {
                "text": "Die transatlantische Partnerschaft bleibt ein Eckpfeiler deutscher AuÃŸenpolitik.",
                "topic": "international",
                "language": "de",
                "date": "2025-09-15",
                "source": "auswaertiges_amt",
                "verified": True
            },
            
            # Zukunftsthemen
            {
                "text": "Deutschland investiert in die Zukunft durch Bildung, Forschung und Innovation fÃ¼r die nÃ¤chste Generation.",
                "topic": "zukunft",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundeskanzleramt",
                "verified": True
            },
            {
                "text": "Die Bundesregierung fÃ¶rdert den Strukturwandel in den Regionen durch den Ausbau von Infrastruktur und ArbeitsplÃ¤tzen.",
                "topic": "regional",
                "language": "de",
                "date": "2025-09-15",
                "source": "bundesministerium_des_innern",
                "verified": True
            }
        ]
        
        # FÃ¼ge Policy-Daten hinzu
        for entry in policy_data:
            category = entry['topic']
            if category not in self.corpus:
                self.corpus[category] = []
            
            # PrÃ¼fe auf Duplikate
            existing_texts = [item['text'] for item in self.corpus[category]]
            if entry['text'] not in existing_texts:
                self.corpus[category].append({
                    'text': entry['text'],
                    'language': entry['language']
                })
        
        print(f"âœ… Korpus um {len(policy_data)} Policy-EintrÃ¤ge erweitert")
        self.save_corpus()
    
    def generate_additional_training_data(self, num_entries_per_category: int = 3) -> None:
        """Generiert zusÃ¤tzliche Trainingsdaten basierend auf vorhandenen Mustern."""
        print(f"ğŸ¤– Generiere zusÃ¤tzliche Trainingsdaten ({num_entries_per_category} pro Kategorie)...")
        
        # Basis-Patterns fÃ¼r verschiedene Kategorien
        generation_patterns = {
            "klima": [
                "Deutschland setzt sich fÃ¼r {} Klimaschutz ein.",
                "Die Bundesregierung fÃ¶rdert {} MaÃŸnahmen zum Klimaschutz.",
                "Bis {} soll {} erreicht werden."
            ],
            "wirtschaft": [
                "Die Bundesregierung unterstÃ¼tzt {} durch {}.",
                "Deutschland investiert in {} zur StÃ¤rkung der Wirtschaft.",
                "{} wird durch {} gefÃ¶rdert."
            ],
            "bildung": [
                "Die Bildungspolitik setzt auf {} und {}.",
                "Deutschland stÃ¤rkt {} in Schulen und Hochschulen.",
                "{} wird durch {} verbessert."
            ],
            "gesundheit": [
                "Das Gesundheitssystem wird durch {} gestÃ¤rkt.",
                "Die Bundesregierung investiert in {} fÃ¼r bessere Gesundheitsversorgung.",
                "{} wird durch {} modernisiert."
            ],
            "technologie": [
                "Deutschland fÃ¼hrt bei {} und {}.",
                "Die Bundesregierung fÃ¶rdert {} durch {}.",
                "{} wird durch {} vorangetrieben."
            ]
        }
        
        # FÃ¼llwÃ¶rter fÃ¼r verschiedene Bereiche
        fillers = {
            "klima": ["ambitionierte", "nachhaltige", "innovative", "internationale", "KlimaneutralitÃ¤t", "2030", "2045"],
            "wirtschaft": ["den Mittelstand", "Start-ups", "die Industrie", "Forschung", "Entwicklung", "FÃ¶rderprogramme"],
            "bildung": ["digitale Kompetenzen", "berufliche Bildung", "lebenslanges Lernen", "moderne Lehrkonzepte", "Bildungsreformen"],
            "gesundheit": ["Digitalisierung", "PrÃ¤vention", "Telemedizin", "Pflege", "KrankenhÃ¤user", "Ã„rzte"],
            "technologie": ["KI-Entwicklung", "Quantencomputing", "Wasserstofftechnologie", "Batterieforschung", "Investitionen"]
        }
        
        import random
        
        generated_count = 0
        for category, patterns in generation_patterns.items():
            if category not in self.corpus:
                self.corpus[category] = []
            
            # Generiere EintrÃ¤ge fÃ¼r diese Kategorie
            for i in range(num_entries_per_category):
                pattern = random.choice(patterns)
                category_fillers = fillers.get(category, [""])
                
                # Ersetze Platzhalter mit zufÃ¤lligen FÃ¼llwÃ¶rtern
                text = pattern
                for placeholder in ["{}", "{}"]:
                    if "{}" in text:
                        filler = random.choice(category_fillers)
                        text = text.replace("{}", filler, 1)
                
                # PrÃ¼fe auf Duplikate
                existing_texts = [item['text'] for item in self.corpus[category]]
                if text not in existing_texts:
                    self.corpus[category].append({
                        'text': text,
                        'language': 'de'
                    })
                    generated_count += 1
        
        print(f"âœ… {generated_count} zusÃ¤tzliche EintrÃ¤ge generiert")
        self.save_corpus()