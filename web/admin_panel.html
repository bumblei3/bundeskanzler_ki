<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Bundeskanzler KI - Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #333; border-bottom: 2px solid #007acc; padding-bottom: 20px; margin-bottom: 30px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #007acc; color: #007acc; font-weight: bold; }
        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; }
        .card { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007acc; }
        .metric { display: inline-block; margin: 10px 20px 10px 0; padding: 10px 15px; background: #e3f2fd; border-radius: 5px; }
        .btn { padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #005a9e; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .log-entry { font-family: monospace; font-size: 12px; margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 3px; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Bundeskanzler KI - Admin Panel</h1>
            <p>Vollst√§ndiges Administrations-Interface</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection">
            <div class="card">
                <h3>Admin Login</h3>
                <div class="input-group">
                    <label>Username:</label>
                    <input type="text" id="username" value="admin">
                </div>
                <div class="input-group">
                    <label>Password:</label>
                    <input type="password" id="password" value="admin123!">
                </div>
                <button class="btn" onclick="login()">Admin Login</button>
                <div id="loginStatus"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="showTab('users')">üë• Benutzer</button>
                <button class="tab" onclick="showTab('logs')">üìã Logs</button>
                <button class="tab" onclick="showTab('memory')">üíæ Memory</button>
                <button class="tab" onclick="showTab('config')">‚öôÔ∏è Config</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h3>System Dashboard</h3>
                <button class="btn" onclick="loadDashboard()">üîÑ Refresh</button>
                <div id="dashboardContent">
                    <p>Klicke auf Refresh um die System-Metriken zu laden...</p>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <h3>Benutzer-Management</h3>
                <button class="btn" onclick="loadUsers()">üë• Benutzer laden</button>
                <div id="usersContent">
                    <p>Klicke auf "Benutzer laden" um alle Benutzer anzuzeigen...</p>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4>Neuen Benutzer erstellen</h4>
                    <div class="input-group">
                        <label>User ID:</label>
                        <input type="text" id="newUserId" placeholder="z.B. max.mustermann">
                    </div>
                    <div class="input-group">
                        <label>Email:</label>
                        <input type="email" id="newUserEmail" placeholder="max@example.com">
                    </div>
                    <div class="input-group">
                        <label>Password:</label>
                        <input type="password" id="newUserPassword" placeholder="sicheres_passwort">
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="newUserAdmin"> Admin-Rechte
                        </label>
                    </div>
                    <button class="btn" onclick="createUser()">‚úÖ Benutzer erstellen</button>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content">
                <h3>Live Log-Viewer</h3>
                <div class="input-group">
                    <label>Log-Datei:</label>
                    <select id="logType">
                        <option value="api.log">API Logs</option>
                        <option value="memory.log">Memory Logs</option>
                        <option value="errors.log">Error Logs</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Anzahl Zeilen:</label>
                    <input type="number" id="logLines" value="20" min="5" max="100">
                </div>
                <button class="btn" onclick="loadLogs()">üìã Logs laden</button>
                <button class="btn" onclick="setInterval(loadLogs, 5000)">üîÑ Auto-Refresh (5s)</button>
                <div id="logsContent">
                    <p>W√§hle eine Log-Datei und klicke "Logs laden"...</p>
                </div>
            </div>

            <!-- Memory Tab -->
            <div id="memory" class="tab-content">
                <h3>Memory-Management</h3>
                <button class="btn" onclick="loadMemoryStats()">üìä Memory Stats</button>
                <div id="memoryContent">
                    <p>Klicke auf "Memory Stats" um Statistiken zu laden...</p>
                </div>
                
                <div class="card" style="margin-top: 20px; border-left-color: #dc3545;">
                    <h4>‚ö†Ô∏è Danger Zone</h4>
                    <p><strong>ACHTUNG:</strong> Das L√∂schen des Memory ist irreversibel!</p>
                    <button class="btn btn-danger" onclick="clearMemory()">üóëÔ∏è Memory komplett leeren</button>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="config" class="tab-content">
                <h3>System-Konfiguration</h3>
                <button class="btn" onclick="loadConfig()">‚öôÔ∏è Konfiguration laden</button>
                <div id="configContent">
                    <p>Klicke auf "Konfiguration laden" um Einstellungen anzuzeigen...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminToken = null;
        const API_URL = 'http://localhost:8000';

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`${API_URL}/auth/admin-token`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    adminToken = data.access_token;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('loginStatus').innerHTML = '<span class="status-ok">‚úÖ Login erfolgreich!</span>';
                } else {
                    document.getElementById('loginStatus').innerHTML = '<span class="status-error">‚ùå Login fehlgeschlagen!</span>';
                }
            } catch (error) {
                document.getElementById('loginStatus').innerHTML = '<span class="status-error">‚ùå Fehler: ' + error.message + '</span>';
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/admin/health`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const health = await response.json();
                    const content = `
                        <div class="metric">
                            <strong>Uptime:</strong> ${health.system.uptime.toFixed(1)}s
                        </div>
                        <div class="metric">
                            <strong>Requests:</strong> ${health.system.request_count}
                        </div>
                        <div class="metric">
                            <strong>Components:</strong> ${health.system.components_initialized ? '‚úÖ OK' : '‚ùå Error'}
                        </div>
                        <div class="metric">
                            <strong>Logs:</strong> ${health.files.logs_accessible ? '‚úÖ OK' : '‚ùå Error'}
                        </div>
                    `;
                    document.getElementById('dashboardContent').innerHTML = content;
                }
            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = '<span class="status-error">Fehler beim Laden der Dashboard-Daten</span>';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let content = '<h4>Benutzer-Liste:</h4>';
                    data.users.forEach(user => {
                        const adminBadge = user.is_admin ? 'üîê Admin' : 'üë§ User';
                        const statusBadge = user.is_active ? '‚úÖ Aktiv' : '‚ùå Inaktiv';
                        content += `
                            <div class="card">
                                <strong>${user.user_id}</strong> (${user.email})<br>
                                ${adminBadge} | ${statusBadge} | Login Count: ${user.login_count}
                            </div>
                        `;
                    });
                    document.getElementById('usersContent').innerHTML = content;
                }
            } catch (error) {
                document.getElementById('usersContent').innerHTML = '<span class="status-error">Fehler beim Laden der Benutzer</span>';
            }
        }

        async function createUser() {
            const userData = {
                user_id: document.getElementById('newUserId').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPassword').value,
                is_admin: document.getElementById('newUserAdmin').checked
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    alert('‚úÖ Benutzer erfolgreich erstellt!');
                    loadUsers(); // Refresh user list
                    // Clear form
                    document.getElementById('newUserId').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserAdmin').checked = false;
                } else {
                    alert('‚ùå Fehler beim Erstellen des Benutzers');
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function loadLogs() {
            const logType = document.getElementById('logType').value;
            const lines = document.getElementById('logLines').value;
            
            try {
                const response = await fetch(`${API_URL}/admin/logs/${logType}?lines=${lines}`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let content = `<h4>${logType} (${data.entries.length} Eintr√§ge):</h4>`;
                    data.entries.reverse().forEach(entry => {
                        const levelColor = {
                            'ERROR': '#dc3545',
                            'WARNING': '#ffc107',
                            'INFO': '#007acc',
                            'DEBUG': '#6c757d'
                        }[entry.level] || '#6c757d';
                        
                        content += `
                            <div class="log-entry" style="border-left: 3px solid ${levelColor}">
                                <strong>${entry.timestamp}</strong> [${entry.level}] ${entry.logger}<br>
                                ${entry.message}
                            </div>
                        `;
                    });
                    document.getElementById('logsContent').innerHTML = content;
                }
            } catch (error) {
                document.getElementById('logsContent').innerHTML = '<span class="status-error">Fehler beim Laden der Logs</span>';
            }
        }

        async function loadMemoryStats() {
            try {
                const response = await fetch(`${API_URL}/admin/memory/stats`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    const content = `
                        <div class="metric">
                            <strong>Kurzzeitged√§chtnis:</strong> ${stats.kurzzeitgedaechtnis_entries || 0}
                        </div>
                        <div class="metric">
                            <strong>Langzeitged√§chtnis:</strong> ${stats.langzeitgedaechtnis_entries || 0}
                        </div>
                        <div class="metric">
                            <strong>Total Entries:</strong> ${stats.total_entries || 0}
                        </div>
                        <div class="metric">
                            <strong>Effizienz:</strong> ${(stats.memory_efficiency || 0).toFixed(1)}%
                        </div>
                    `;
                    document.getElementById('memoryContent').innerHTML = content;
                } else {
                    document.getElementById('memoryContent').innerHTML = '<span class="status-error">Memory Stats nicht verf√ºgbar</span>';
                }
            } catch (error) {
                document.getElementById('memoryContent').innerHTML = '<span class="status-error">Fehler beim Laden der Memory-Stats</span>';
            }
        }

        async function clearMemory() {
            if (confirm('‚ö†Ô∏è ACHTUNG: M√∂chten Sie wirklich das gesamte Memory l√∂schen? Dies ist irreversibel!')) {
                try {
                    const response = await fetch(`${API_URL}/admin/memory/clear`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert('‚úÖ Memory erfolgreich geleert! Backup: ' + result.backup);
                        loadMemoryStats();
                    } else {
                        alert('‚ùå Fehler beim Leeren des Memory');
                    }
                } catch (error) {
                    alert('‚ùå Fehler: ' + error.message);
                }
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch(`${API_URL}/admin/config`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const config = await response.json();
                    let content = '<h4>System-Konfiguration:</h4>';
                    
                    Object.entries(config).forEach(([section, settings]) => {
                        content += `<div class="card">
                            <h5>${section.replace('_', ' ').toUpperCase()}</h5>
                            <pre>${JSON.stringify(settings, null, 2)}</pre>
                        </div>`;
                    });
                    
                    document.getElementById('configContent').innerHTML = content;
                }
            } catch (error) {
                document.getElementById('configContent').innerHTML = '<span class="status-error">Fehler beim Laden der Konfiguration</span>';
            }
        }
    </script>
</body>
</html>